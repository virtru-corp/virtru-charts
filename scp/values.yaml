# Default values for scp.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# -- Some yaml anchor definitions for convenience
commonParams:
  attrEndpoint: &attrEndpoint "http://attributes:4020"
  #Disable OTEL Tracing
  disableTracing: &disableTracing "true"
  entitlementPolicyBundleRepo: &entitlementPolicyBundleRepo "scp-docker-registry:5000/entitlements-policybundle"
  entitlementPolicyBundleTag: &entitlementPolicyBundleTag 0.0.2
  entilementPolicyOCIRegistryUrl: &entilementPolicyOCIRegistryUrl "https://scp-docker-registry:5000"
  scpImagePullSecretName: &scpImagePullSecretName "scp-pull-secret"
  imagePullSecrets: &imagePullSecrets
    - name: *scpImagePullSecretName

nameOverride: ""
fullnameOverride: ""

embedded:
  # -- Use an embedded keycloak or not
  keycloak: true
  # -- Use an embedded postgres or not
  postgresql: true

#-- Keycloak bootstrap parameters
bootstrap:
  #-- Should keycloak bootstrap be enabled
  keycloak: true
  #-- Configuration service boostrapping configuration
  configsvc:
    #-- Enable configuration service artifact bootstrapping
    enabled: true
    #-- Config svc artifact bootstrapping job config
    job:
      name: configsvc-bootstrap
      image:
        repo: ghcr.io/virtru-corp/postman-cli/opcr-policy
        tag: sha-531eea2
        pullPolicy: IfNotPresent
      backoffLimit: 5
      #-- Secret name used to mount configuration artifacts used by the job
      configVolumeSecretRefName: scp-bootstrap-configsvc
      #-- secret for environment variables
      envSecretRef:
  #-- The path to the install configuration file (relative to the chart directory)
  configPath:
  #-- Should entitlement policy be bootstrapped
  entitlementPolicy: true

ingress:
  #-- Use an existing istio gateway
  existingGateway:
  #-- Name of istio gateway selector
  gatewaySelector: ingress
  name: scp

global:
  opentdf:
    common:
      oidcExternalBaseUrl: https://scp.virtrudemos.com
      oidcInternalBaseUrl: http://keycloak-http
      oidcUrlPath: auth
      ingress:
        scheme: "https"
        hostname: "scp.virtrudemos.com"
      postgres:
        # -- postgres server's k8s name or global DNS for external server
        host: postgresql
        # -- postgres server port
        port: 5432
        # -- The database name within the given server
        database: tdf_database

abacus:
  # -- abacus enabled flag
  enabled: true
  basePath: "/abacus"
  fullnameOverride: abacus
  ingress:
    enabled: false

access-pep:
  # -- Enable access-pep flag
  enabled: true
  # -- Name override
  name: access-pep
  # -- Existing pull secrets
  existingImagePullSecret: *scpImagePullSecretName
  image:
    repo: ghcr.io/virtru-corp/access-pep/access-pep
    tag: sha-cac697c
  # -- Access Pep configuration
  config:
    disableTracing: *disableTracing
    attrAuthorityHost: *attrEndpoint
    entitlementPdpHost: "http://entitlement-pdp:3355"
    keycloakAttrAuthorityClientID: "tdf-client"
    keycloakAttrAuthorityClientSecret:

# Attribute Chart Overrides
attributes:
  # -- Attribute Service Name Override
  fullnameOverride: attributes
  secretRef: |-
    name: scp-attributes-secret



# Configuration Chart Overrides
configuration:
  # -- Configuration Service enabled flag
  enabled: true
  # -- Configuration svc name override
  fullnameOverride: configuration
  server:
    image:
      tag: 0.3.5
    secretRef: |-
      name: scp-configsvc
    postgres:
      host: postgresql
      # Override with value
      password:
    imagePullSecrets: *imagePullSecrets

# Entitlement Policy Bootstrap Job parameters
entitlement-policy-bootstrap:
  # -- The Glob Pattern to the entitlement policy source data . e.g. rego + data.json
  policyGlobPattern: "configs/fed-demo/entitlement-policy/*"
  # -- Bundle repository
  bundleRepo: *entitlementPolicyBundleRepo
  # -- Bundle Tag
  bundleTag: *entitlementPolicyBundleTag
  # -- URL of OCI registry to publish to
  OCIRegistryUrl: *entilementPolicyOCIRegistryUrl
  # -- Config map name used to inject env varibles into the job
  policyConfigMap: scp-bootstrap-entitlement-cm
  # -- Secret name used to mount policy artifacts into the job
  policyDataSecretRef: scp-bootstrap-entitlement-policy
  # -- Image pull secrets for the job
  imagePullSecrets: *imagePullSecrets
  image:
    # -- ocpr container tag
    tag: sha-531eea2

# Entitlement PDP Chart Overrides
entitlement-pdp:
  # -- Entitlement PDP name override
  fullnameOverride: entitlement-pdp
  opaConfig:
    policy:
      # -- Use static policy flag - false to pull from oci registry
      useStaticPolicy: false
      allowInsecureTLS: true
      OCIRegistryUrl: *entilementPolicyOCIRegistryUrl
      # -- Resource path to use to download bundle from configured service
      bundleRepo: *entitlementPolicyBundleRepo
      bundleTag: *entitlementPolicyBundleTag
  config:
    disableTracing: *disableTracing
  secretRef: |-
    name: scp-entitlement-pdp-secret

entitlement-store:
  # -- Entitlement Store name override
  fullnameOverride: entitlement-store
  secretRef: |-
    name: scp-entitlement-store-secret

entitlements:
  # -- Entitlements Name Override
  fullnameOverride: entitlements
  secretRef: |-
    name: scp-entitlements-secret    

entity-resolution:
  # -- Entity Resolution Name override
  fullnameOverride: entity-resolution
  config:
    disableTracing: *disableTracing
    keycloak:
      legacy: true

kas:
  # -- KAS Name Override
  fullnameOverride: kas
  endpoints:
    # -- Attributes hostname accessible to KAS
    attrHost: *attrEndpoint
  pdp:
    verbose: "true"
    # -- Disable tracing flag
    disableTracing: *disableTracing

keycloak:
  # -- keycloak name override
  fullnameOverride: keycloak
  image:
    repository: ghcr.io/opentdf/keycloak
    tag: main
    pullPolicy: IfNotPresent
  # -- Command to start the keycloak service
  command:
    - "/opt/keycloak/bin/kc.sh"
    - "--verbose"
    - "start-dev"
    - "--http-relative-path"
    - "/auth"
  postgresql:
    enabled: false
  externalDatabase:
    database: keycloak_database
  # -- Extra environment variables.
  extraEnv: |-
    - name: CLAIMS_URL
      value: http://entitlement-pdp:3355/entitlements
    - name: JAVA_OPTS_APPEND
      value: -Djgroups.dns.query={{ include "keycloak.fullname" . }}-headless
    - name: KC_DB
      value: postgres
    - name: KC_DB_URL_PORT
      value: "5432"
    - name: KC_LOG_LEVEL
      value: INFO
    - name: KC_HOSTNAME_STRICT
      value: "false"
    - name: KC_HOSTNAME_STRICT_BACKCHANNEL
      value: "false"
    - name: KC_HOSTNAME_STRICT_HTTPS
      value: "false"
    - name: KC_HOSTNAME_URL
      value: {{ ( include "keycloak.externalUrl" . ) | quote }}
    - name: KC_HOSTNAME_ADMIN_URL
      value: {{ ( include "keycloak.externalUrl" . ) | quote }}
    - name: KC_HTTP_ENABLED
      value: "true"
    - name: KC_FEATURES
      value: "preview,token-exchange"
  extraEnvFrom: |-
    - secretRef:
        name: scp-keycloak-secret

keycloak-bootstrap:
  entitlements:
    # -- Entitlement svc hostname
    hostname: http://entitlements:4030
    # -- Entitlement override realms
    realms: null
  # -- Secret name used to Mount bootstrapping data
  existingConfigSecret: scp-keycloakbootstrap-config
  # -- Secret for bootstrap job env variables.
  secretRef: |-
    name: scp-keycloakbootstrap-secret
  attributes:
    # -- Attribute service endpoint accessible to boostrap job
    hostname: *attrEndpoint
    # -- Realm for OIDC client auth to attribute service
    realm: tdf
    # -- OIDC client ID used to auth to attribute service
    clientId: dcr-test

docker-registry:
  # -- Enable docker registry
  enabled: true
  persistence:
    # -- Persistence Enabled Flag
    enabled: true
    size: 1Gi
  # -- Secret name containing TLS Certs used by the registry
  tlsSecretName: scp-docker-registry-certs

postgresql:
  # -- Postgresql Name override
  fullnameOverride: postgresql
  image:
    debug: true
    tag: "11"
  auth:
    existingSecret: >
      {{ include "postgresql.primary.fullname" . }}-secret
  primary:
    initdb:
      user: postgres
      scriptsSecret: >
        {{ include "postgresql.primary.fullname" . }}-initdb-secret

# Templates for generating secrets
secrets:
  # -- Generate secrets from the values provided below.  If false, another bootstrapping
  # mechanism for secrets is required.
  enabled: true
  postgresql:
    # -- password for postgres user
    dbPassword:
  attributes:
    # -- oidc client secret used by attributes svc to auth to idp and enforce svc authorization
    clientSecret:
    # -- postgres password for attributes svc user
    dbPassword:
  configuration:
    # -- postgres password for config svc user
    dbPassword:
  entitlementStore:
    # -- postgres password for entitlement-store svc user
    dbPassword:
  entitlements:
    # -- oidc client secret used by entitlements svc to auth to idp and enforce svc authorization
    clientSecret:
    # -- postgres password for entitlements svc user
    dbPassword:
  keycloak:
    # -- postgres password for keycloak svc user
    dbPassword:
    # -- keycloak admin user's username
    adminUsername:
    # -- Keycloak admin user's password
    adminPassword:
  keycloakBootstrap:
    # -- username for attribute service auth
    attributesUsername:
    # -- password for attribute service auth
    attributesPassword:
    # -- list of users to be added
    users:
    # -- list of custom oidc clients to add
    clients:
    # -- client secret assigned to standard bootstrapper clients
    clientSecret:
    customConfig: null
  # -- oci registry pull secret for OPA policy
  opaPolicyPullSecret:
  # -- Image pull credentials.
  imageCredentials:
    - name: scp-pull-secret
      registry: ghcr.io
      username: username
      password: password
      email: nope@nah.com

# Tagging PDP Chart Overrides
tagging-pdp:
  # -- Tagging-PDP enabled flag
  enabled: true
  fullnameOverride: tagging-pdp
  image:
    tag: sha-470efff
    pullSecrets: *imagePullSecrets
  gateway:
    # -- Tagging PDP Rest Gateway enabled flag
    enabled: true
    pathPrefix: tagging-pdp
    image:
      tag: sha-e28d7ee

# -- The admin user created for tdf.
tdfAdminUsername: tdf-admin