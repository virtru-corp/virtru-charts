
global:
  ## @skip global.opentdf
  opentdf:
    common:
      oidcExternalBaseUrl: https://demo.com
      oidcInternalBaseUrl: http://keycloak-http
      oidcUrlPath: auth
      ingress:
        scheme: "https"
        hostname: "demo.com"
      postgres:
        # -- postgres server's k8s name or global DNS for external server
        host: postgresql
        # -- postgres server port
        port: 5432

## @param fullnameOverride Chart full name override
fullnameOverride: "scp-embedded"

## @section Keycloak Chart Overrides
keycloak:
  ## @param keycloak.fullnameOverride keycloak name override
  fullnameOverride: keycloak
  image:
    ## @param keycloak.image.repository Keycloak Image Repo
    repository: ghcr.io/opentdf/keycloak
    ## @param keycloak.image.tag Keycloak Image Tag
    tag: main
    ## @param keycloak.image.pullPolicy Keycloak Image pull policy
    pullPolicy: IfNotPresent
  ## @param keycloak.command Command to start the keycloak service
  command:
    - "/opt/keycloak/bin/kc.sh"
    - "--verbose"
    - "start-dev"
    - "--http-relative-path"
    - "/auth"
  postgresql:
    ## @param keycloak.postgresql.enabled Use keycloak deployed postgres flag
    enabled: false
  ## @skip  keycloak.podAnnotations.proxy.istio.io/config
  podAnnotations:
    proxy.istio.io/config: '{ "holdApplicationUntilPRoxyStarts": true }'
  externalDatabase:
    ## @param keycloak.externalDatabase.database Database name
    database: keycloak_database
  ## @param keycloak.extraEnv Extra environment variables.
  extraEnv: |-
    - name: CLAIMS_URL
      value: http://entitlement-pdp:3355/entitlements
    - name: JAVA_OPTS_APPEND
      value: -Djgroups.dns.query={{ include "keycloak.fullname" . }}-headless
    - name: KC_DB
      value: postgres
    - name: KC_DB_URL_PORT
      value: "5432"
    - name: KC_LOG_LEVEL
      value: INFO
    - name: KC_HOSTNAME_STRICT
      value: "false"
    - name: KC_HOSTNAME_STRICT_BACKCHANNEL
      value: "false"
    - name: KC_HOSTNAME_STRICT_HTTPS
      value: "false"
    - name: KC_HOSTNAME_URL
      value: {{ ( include "shp.embedded.keycloak.oidc.externalUrl" . ) | quote }}
    - name: KC_HOSTNAME_ADMIN_URL
      value: {{ ( include "shp.embedded.keycloak.oidc.externalUrl" . ) | quote }}
    - name: KC_HTTP_ENABLED
      value: "true"
    - name: KC_FEATURES
      value: "preview,token-exchange"
  ## @param keycloak.extraEnvFrom Extra Environment From Reference YAML
  extraEnvFrom: |-
    - secretRef:
        name: scp-embedded-keycloak-secret

secrets:
  keycloak:
    ## @param secrets.keycloak.dbPassword postgres password for keycloak svc user
    dbPassword:
    ## @param secrets.keycloak.adminUsername keycloak admin user's username
    adminUsername:
    ## @param secrets.keycloak.adminPassword Keycloak admin user's password
    adminPassword: